# 断言关键字使用文档

pytest-dsl提供了一组强大的断言关键字，用于验证不同类型的数据，包括字符串、数字、JSON等。本文档介绍这些断言关键字的使用方法和示例。

## 目录

- [断言](#断言)
- [JSON断言](#json断言)
- [JSON提取](#json提取)
- [类型断言](#类型断言)
- [数据比较](#数据比较)

## 断言

通用断言关键字，支持各种比较操作和表达式计算。

### 参数

| 参数名 | 描述 | 是否必填 |
|--------|------|----------|
| 条件 | 断言条件表达式 | 是 |
| 消息 | 断言失败时的错误消息 | 否 |

### 支持的操作符

- `==`: 等于
- `!=`: 不等于
- `>`: 大于
- `<`: 小于
- `>=`: 大于等于
- `<=`: 小于等于
- `contains`: 包含
- `not_contains`: 不包含
- `matches`: 正则表达式匹配

### 表达式支持

断言关键字支持两种格式的条件表达式：

1. **比较表达式**：`left_value operator right_value`
   - `left_value` 可以是一个变量引用或计算表达式
   - `right_value` 是要比较的值

2. **直接表达式**：任何有效的Python表达式，结果为布尔值

### 数据类型处理

断言关键字支持多种数据类型的智能处理：

1. **布尔值**：
   - 支持字符串形式的布尔值('True'/'False')与布尔值(True/False)的自动转换和比较
   - 不区分大小写，'true'、'TRUE'、'True' 均视为等同于 True

2. **数字**：
   - 字符串形式的数字会自动转换为对应的数值类型
   - 支持整数和浮点数

3. **字符串**：
   - 支持字符串的各种比较操作
   - 支持字符串方法如 upper(), lower(), split() 等

### 示例

```
# 基本比较
[断言],条件:'1 + 1 == 2',消息:'基本算术断言失败'

# 表达式计算支持
[断言],条件:'(5 * 10) > 45',消息:'算术表达式断言失败'

# 表达式与变量结合
value = 10
[断言],条件:'${value} * 2 == 20',消息:'变量表达式断言失败'

# 直接表达式
[断言],条件:'len("Hello") == 5',消息:'字符串长度断言失败'

# 变量比较
value = 100
[断言],条件:'${value} > 50',消息:'数值断言失败'

# 字符串包含
text = "Hello, World!"
[断言],条件:'${text} contains "Hello"',消息:'字符串包含断言失败'

# 正则表达式匹配
[断言],条件:'${text} matches "^Hello.*!$"',消息:'正则表达式断言失败'

# 布尔值比较
[断言],条件:'True == True',消息:'布尔值相等断言失败'
[断言],条件:'"true" == True',消息:'字符串形式布尔值断言失败'

# 布尔值表达式
[断言],条件:'True and not False',消息:'布尔值表达式断言失败'
```

## JSON断言

专门用于验证JSON数据的断言关键字，支持使用JSONPath提取数据进行比较。

### 参数

| 参数名 | 描述 | 是否必填 |
|--------|------|----------|
| JSON数据 | JSON数据（字符串或对象） | 是 |
| JSONPath | JSONPath表达式 | 是 |
| 预期值 | 预期的值 | 是 |
| 操作符 | 比较操作符，默认为"==" | 否 |
| 消息 | 断言失败时的错误消息 | 否 |

### 示例

```
json_data = '{"user": {"name": "张三", "age": 30, "roles": ["admin", "user"]}}'

# 基本JSON断言
[JSON断言],
    JSON数据:${json_data},
    JSONPath:'$.user.name',
    预期值:'张三',
    消息:'JSON断言失败：用户名不匹配'

# 使用不同操作符
[JSON断言],
    JSON数据:${json_data},
    JSONPath:'$.user.age',
    预期值:25,
    操作符:'>',
    消息:'JSON断言失败：年龄不正确'

# 数组元素断言
[JSON断言],
    JSON数据:${json_data},
    JSONPath:'$.user.roles[0]',
    预期值:'admin',
    消息:'JSON断言失败：角色不匹配'
```

## JSON提取

从JSON数据中提取值并保存到变量，可用于后续断言或操作。

### 参数

| 参数名 | 描述 | 是否必填 |
|--------|------|----------|
| JSON数据 | JSON数据（字符串或对象） | 是 |
| JSONPath | JSONPath表达式 | 是 |
| 变量名 | 存储提取值的变量名 | 是 |

### 示例

```
json_data = '{"user": {"name": "张三", "age": 30}}'

# 提取值并保存到变量
username = [JSON提取],JSON数据:${json_data},JSONPath:'$.user.name',变量名:'username'

# 使用提取的值
[断言],条件:'${username} == "张三"',消息:'JSON提取断言失败'
```

## 类型断言

验证值的数据类型是否符合预期。

### 参数

| 参数名 | 描述 | 是否必填 |
|--------|------|----------|
| 值 | 要检查的值 | 是 |
| 类型 | 预期的类型 | 是 |
| 消息 | 断言失败时的错误消息 | 否 |

### 支持的类型

- `string`: 字符串
- `number`: 数字（整数或浮点数）
- `boolean`: 布尔值
- `list`: 列表/数组
- `object`: 对象/字典
- `null`: 空值

### 示例

```
# 字符串类型断言
text = "Hello"
[类型断言],值:${text},类型:'string',消息:'类型断言失败'

# 数字类型断言
num = 42
[类型断言],值:${num},类型:'number',消息:'类型断言失败'

# JSON对象类型断言
json_obj = {"key": "value"}
[类型断言],值:${json_obj},类型:'object',消息:'类型断言失败'
```

## 数据比较

直接比较两个值，不需要构造表达式。

### 参数

| 参数名 | 描述 | 是否必填 |
|--------|------|----------|
| 实际值 | 实际值 | 是 |
| 预期值 | 预期值 | 是 |
| 操作符 | 比较操作符，默认为"==" | 否 |
| 消息 | 断言失败时的错误消息 | 否 |

### 示例

```
# 基本比较
[数据比较],实际值:100,预期值:100,消息:'数据比较失败'

# 使用变量
value1 = 200
value2 = 100
[数据比较],实际值:${value1},预期值:${value2},操作符:'>',消息:'数据比较失败'

# 字符串比较
[数据比较],实际值:"Hello",预期值:"hello",操作符:'!=',消息:'数据比较失败'
```

## 高级用法

### 组合多个断言

您可以组合多个断言来验证复杂的场景：

```
# API调用获取用户信息
[API接口调用],
    方法:'GET',
    URL:'https://api.example.com/users/1',
    请求头:'{"Content-Type":"application/json"}'

# 保存响应数据
response = [获取响应内容]

# 提取用户ID和名称
user_id = [JSON提取],JSON数据:${response},JSONPath:'$.id',变量名:'user_id'
user_name = [JSON提取],JSON数据:${response},JSONPath:'$.name',变量名:'user_name'

# 验证用户信息
[数据比较],实际值:${user_id},预期值:1,消息:'用户ID不匹配'
[类型断言],值:${user_name},类型:'string',消息:'用户名类型不正确'
[断言],条件:'${user_name} != ""',消息:'用户名不能为空'
```

### 处理复杂的JSON结构

您可以使用JSONPath处理复杂的JSON结构：

```
json_data = '{
  "results": [
    {"name": "张三", "scores": [90, 85, 92]},
    {"name": "李四", "scores": [80, 75, 88]}
  ],
  "metadata": {"total": 2, "page": 1}
}'

# 提取第一个用户的最高分数
highest_score = [JSON提取],JSON数据:${json_data},JSONPath:'$.results[0].scores[0]',变量名:'highest_score'

# 验证分数
[断言],条件:'${highest_score} > 85',消息:'最高分数不正确'

# 验证用户总数
[JSON断言],
    JSON数据:${json_data},
    JSONPath:'$.metadata.total',
    预期值:2,
    消息:'用户总数不正确'
```

## JSONPath语法参考

JSONPath是一种用于从JSON数据中提取数据的查询语言。以下是常用的JSONPath表达式：

| 表达式 | 描述 |
|--------|------|
| `$` | 根对象 |
| `.property` | 访问属性 |
| `['property']` | 访问属性（替代语法） |
| `[index]` | 访问数组索引 |
| `[start:end]` | 数组切片 |
| `..property` | 递归搜索属性 |
| `*` | 通配符，匹配所有属性或数组元素 |
| `[?(@.property)]` | 过滤表达式 |
| `[?(@.property==value)]` | 过滤比较表达式 |

### 示例

```
$.store.book[0].title          # 第一本书的标题
$.store.book[*].author         # 所有书的作者
$..book[?(@.price<10)].title   # 所有价格小于10的书的标题
$.store.book[-1:]              # 最后一本书
$.store.book[0:2]              # 前两本书
``` 