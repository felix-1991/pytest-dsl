# 实时变量同步功能说明

## 概述

pytest-dsl 现在支持在执行DSL语句时实时同步所有上下文变量到远程服务器，确保远程关键字能够访问到最新的变量状态。

## 功能特性

### 1. 连接时初始同步 ✅
- 客户端连接到远程服务器时，自动同步所有现有的上下文变量
- 包括全局变量（g_开头）、YAML配置变量、和自定义变量

### 2. 执行前实时同步 ✅
- 每次执行远程关键字前，自动同步最新的上下文变量
- 确保远程关键字能够访问到最新的变量状态

### 3. 变量变化立即同步 ✅ (已验证)
- 每当DSL中的变量发生变化时，立即同步到所有连接的远程服务器
- 支持以下变量变化场景：
  - 普通变量赋值 (`用户名 = "张三"`)
  - 关键字结果赋值 (`结果 = [执行关键字]`)
  - 循环变量变化 (`for i in [1, 2, 3] do`)
  - 远程关键字赋值和捕获变量

### 4. 安全过滤机制 ✅ (已验证)
- 自动排除敏感变量（包含 password、secret、token、credential、auth、private 等关键词）
- 可配置排除模式，保护敏感信息不被同步

## 同步的变量类型

1. **本地变量**: DSL执行过程中设置的变量
2. **全局变量**: 以 `g_` 开头的全局变量
3. **YAML配置变量**: 从配置文件加载的变量
4. **外部提供者变量**: 通过变量提供者注入的变量
5. **捕获变量**: 远程关键字执行后捕获的变量

## 使用示例

### 基本用法

```dsl
@name 变量同步示例
@remote_server http://localhost:8270|demo_server

# 设置变量
设置变量: 用户名 = "张三"
设置变量: 年龄 = 25

# 远程关键字可以直接访问这些变量
执行远程关键字: demo_server|显示用户信息
    参数:
        - 用户: ${用户名}
        - 年龄: ${年龄}

# 修改变量后立即同步
设置变量: 年龄 = 26

# 远程关键字获取到更新后的值
执行远程关键字: demo_server|显示用户信息
    参数:
        - 用户: ${用户名}
        - 年龄: ${年龄}  # 值为 26
```

### 循环中的变量同步

```dsl
重复执行: i 在 [1, 2, 3] 中
    设置变量: 当前索引 = ${i}
    # 每次循环都会同步当前索引值
    执行远程关键字: demo_server|处理数据
        参数:
            - 索引: ${当前索引}
```

### 全局变量同步

```dsl
# 全局变量会自动同步到所有远程服务器
设置变量: g_项目名称 = "pytest-dsl"
设置变量: g_环境 = "测试环境"

# 远程关键字可以访问全局变量
执行远程关键字: demo_server|获取项目信息
    参数:
        - 项目: ${g_项目名称}
        - 环境: ${g_环境}
```

## 同步时机

1. **连接时**: 客户端连接远程服务器时同步所有现有变量
2. **执行前**: 执行远程关键字前同步最新的上下文变量
3. **变量变化时**: 每当变量发生变化时立即同步

## 日志输出

同步过程中会产生详细的日志输出：

```
✅ 实时同步 5 个上下文变量到远程服务器
🔄 变量 用户名 已同步到远程服务器 demo_server
🔄 变量 年龄 已同步到远程服务器 demo_server
🔒 跳过敏感变量同步: api_secret
```

## 配置选项

可以通过同步配置控制同步行为：

```python
sync_config = {
    'sync_global_vars': True,          # 同步全局变量
    'sync_yaml_vars': True,            # 同步YAML变量
    'sync_custom_vars': True,          # 同步自定义变量
    'yaml_exclude_patterns': [         # 排除模式
        'password', 'secret', 'token', 
        'credential', 'auth', 'private'
    ]
}
```

## 远程服务器端

远程服务器通过变量桥接机制让关键字能够无缝访问同步的变量：

```python
# 远程关键字可以直接通过变量名访问同步的变量
@keyword("显示用户信息")
def show_user_info(用户, 年龄):
    print(f"用户: {用户}, 年龄: {年龄}")
    
    # 也可以通过yaml_vars访问
    from pytest_dsl.core.yaml_vars import yaml_vars
    user_name = yaml_vars.get_variable("用户名")
    user_age = yaml_vars.get_variable("年龄")
```

## 性能优化

- 变量同步采用增量方式，只同步变化的变量
- 自动排除敏感变量，减少网络传输
- 支持批量同步，提高效率
- 缓存机制避免重复同步相同的变量值

## 故障处理

- 同步失败不会影响DSL的正常执行
- 提供详细的错误日志便于调试
- 支持重试机制确保同步的可靠性

这个功能确保了分布式执行环境中变量状态的一致性，让远程关键字能够无感知地访问客户端的所有上下文变量。 